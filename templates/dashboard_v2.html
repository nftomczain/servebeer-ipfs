<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ServeBeer Dashboard v2 | IPFS Guerrilla Infrastructure</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
            color: #ECF0F1;
            min-height: 100vh;
            overflow-x: hidden;
        }

        /* Beta Banner */
        .beta-banner {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            background: linear-gradient(45deg, #f39c12, #e67e22);
            color: white;
            padding: 8px;
            text-align: center;
            font-weight: bold;
            z-index: 1000;
            font-size: 0.9rem;
            box-shadow: 0 2px 10px rgba(0,0,0,0.3);
        }

        /* Header */
        .header {
            margin-top: 40px;
            background: rgba(26, 188, 156, 0.1);
            backdrop-filter: blur(10px);
            border-bottom: 1px solid #4ECDC4;
            padding: 20px 0;
            position: sticky;
            top: 40px;
            z-index: 100;
        }

        .header-container {
            max-width: 1400px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 20px;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .logo-icon {
            width: 50px;
            height: 50px;
            background: linear-gradient(45deg, #4ECDC4, #45B7B8);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.8rem;
            box-shadow: 0 4px 15px rgba(78, 205, 196, 0.3);
        }

        .logo-text {
            font-size: 1.8rem;
            font-weight: bold;
            color: #4ECDC4;
            text-shadow: 0 0 20px rgba(78, 205, 196, 0.3);
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .user-avatar {
            width: 40px;
            height: 40px;
            background: linear-gradient(45deg, #9B59B6, #8E44AD);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
        }

        .network-status {
            display: flex;
            align-items: center;
            gap: 8px;
            background: rgba(52, 152, 219, 0.2);
            padding: 8px 12px;
            border-radius: 8px;
            border: 1px solid #3498DB;
        }

        .status-dot {
            width: 8px;
            height: 8px;
            background: #27AE60;
            border-radius: 50%;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(39, 174, 96, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(39, 174, 96, 0); }
            100% { box-shadow: 0 0 0 0 rgba(39, 174, 96, 0); }
        }

        /* Main Content */
        .main-container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 30px 20px;
        }

        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 20px;
            margin-bottom: 30px;
        }

        /* Stats Cards */
        .stats-section {
            grid-column: span 3;
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
        }

        .stat-card {
            background: rgba(52, 73, 94, 0.8);
            border: 1px solid #34495E;
            border-radius: 15px;
            padding: 20px;
            text-align: center;
            position: relative;
            overflow: hidden;
            transition: all 0.3s ease;
        }

        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 30px rgba(78, 205, 196, 0.2);
            border-color: #4ECDC4;
        }

        .stat-number {
            font-size: 2rem;
            font-weight: bold;
            color: #4ECDC4;
            margin-bottom: 5px;
            text-shadow: 0 0 10px rgba(78, 205, 196, 0.3);
        }

        .stat-label {
            color: #BDC3C7;
            font-size: 0.9rem;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .stat-trend {
            font-size: 0.8rem;
            margin-top: 5px;
        }

        .trend-up { color: #27AE60; }
        .trend-down { color: #E74C3C; }

        /* Quick Actions */
        .quick-actions {
            background: rgba(52, 73, 94, 0.8);
            border: 1px solid #34495E;
            border-radius: 15px;
            padding: 20px;
        }

        .quick-actions h3 {
            color: #4ECDC4;
            margin-bottom: 15px;
            font-size: 1.1rem;
        }

        .action-btn {
            display: block;
            width: 100%;
            padding: 12px;
            margin-bottom: 10px;
            background: linear-gradient(45deg, #4ECDC4, #45B7B8);
            color: white;
            text-decoration: none;
            border-radius: 8px;
            text-align: center;
            font-weight: bold;
            transition: all 0.3s ease;
            border: none;
            cursor: pointer;
        }

        .action-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(78, 205, 196, 0.4);
        }

        .action-btn.secondary {
            background: linear-gradient(45deg, #95A5A6, #7F8C8D);
        }

        .action-btn.danger {
            background: linear-gradient(45deg, #E74C3C, #C0392B);
        }

        /* Full width sections */
        .section {
            background: rgba(52, 73, 94, 0.8);
            border: 1px solid #34495E;
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 20px;
        }

        .section h3 {
            color: #4ECDC4;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 1.3rem;
        }

        /* File Manager */
        .file-search {
            padding: 10px;
            background: rgba(26, 188, 156, 0.1);
            border: 1px solid rgba(78, 205, 196, 0.3);
            border-radius: 8px;
            color: #ECF0F1;
            width: 250px;
            float: right;
            margin-bottom: 15px;
        }

        .file-search::placeholder {
            color: #95A5A6;
        }

        .file-table {
            width: 100%;
            border-collapse: collapse;
            clear: both;
        }

        .file-table th,
        .file-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #34495E;
        }

        .file-table th {
            background: rgba(26, 188, 156, 0.1);
            color: #4ECDC4;
            font-weight: bold;
            font-size: 0.9rem;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .file-table tr:hover {
            background: rgba(78, 205, 196, 0.05);
        }

        .file-name {
            color: #ECF0F1;
            font-weight: 500;
        }

        .file-cid {
            font-family: monospace;
            color: #95A5A6;
            font-size: 0.9rem;
        }

        .file-size {
            color: #4ECDC4;
        }

        .file-type {
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.8rem;
            font-weight: bold;
        }

        .type-upload {
            background: rgba(46, 204, 113, 0.2);
            color: #2ECC71;
        }

        .type-pin {
            background: rgba(52, 152, 219, 0.2);
            color: #3498DB;
        }

        .file-actions {
            display: flex;
            gap: 5px;
        }

        .action-icon {
            padding: 5px;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .action-icon:hover {
            background: rgba(78, 205, 196, 0.2);
        }

        /* Analytics Charts - FIXED LAYOUT */
        .analytics-section {
            background: rgba(52, 73, 94, 0.8);
            border: 1px solid #34495E;
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 20px;
        }

        .analytics-section h3 {
            color: #4ECDC4;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 1.3rem;
        }

        .charts-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin-bottom: 25px;
        }

        .chart-wrapper {
            background: rgba(26, 188, 156, 0.05);
            border: 1px solid rgba(78, 205, 196, 0.2);
            border-radius: 10px;
            padding: 20px;
            height: 300px; /* FIXED HEIGHT */
        }

        .chart-title {
            color: #4ECDC4;
            margin-bottom: 15px;
            text-align: center;
            font-size: 1rem;
            font-weight: bold;
        }

        .chart-canvas {
            position: relative;
            height: 250px !important; /* ENFORCE HEIGHT */
            width: 100% !important;
        }

        .bandwidth-chart {
            grid-column: span 2;
            height: 200px; /* SMALLER FOR BANDWIDTH */
        }

        .bandwidth-chart .chart-canvas {
            height: 150px !important;
        }

        /* Activity Section */
        .activity-grid {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 20px;
        }

        .recent-activity {
            background: rgba(52, 73, 94, 0.8);
            border: 1px solid #34495E;
            border-radius: 15px;
            padding: 20px;
        }

        .recent-activity h3 {
            color: #4ECDC4;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .activity-item {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 12px;
            margin-bottom: 10px;
            background: rgba(26, 188, 156, 0.05);
            border-radius: 8px;
            border-left: 3px solid #4ECDC4;
        }

        .activity-icon {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.9rem;
        }

        .activity-icon.pin {
            background: rgba(52, 152, 219, 0.2);
            color: #3498DB;
        }

        .activity-icon.upload {
            background: rgba(46, 204, 113, 0.2);
            color: #2ECC71;
        }

        .activity-icon.login {
            background: rgba(155, 89, 182, 0.2);
            color: #9B59B6;
        }

        .activity-details {
            flex: 1;
        }

        .activity-text {
            color: #ECF0F1;
            font-size: 0.9rem;
        }

        .activity-time {
            color: #95A5A6;
            font-size: 0.8rem;
            margin-top: 2px;
        }

        /* Network Health */
        .network-health {
            background: rgba(52, 73, 94, 0.8);
            border: 1px solid #34495E;
            border-radius: 15px;
            padding: 20px;
        }

        .network-health h3 {
            color: #4ECDC4;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .health-metrics {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }

        .health-metric {
            background: rgba(26, 188, 156, 0.1);
            padding: 15px;
            border-radius: 8px;
            border: 1px solid rgba(78, 205, 196, 0.3);
            text-align: center;
        }

        .metric-value {
            font-size: 1.3rem;
            font-weight: bold;
            color: #4ECDC4;
        }

        .metric-label {
            font-size: 0.8rem;
            color: #95A5A6;
            margin-top: 5px;
        }

        /* Responsive Design */
        @media (max-width: 1200px) {
            .dashboard-grid {
                grid-template-columns: 1fr 1fr 1fr;
            }
            
            .stats-section {
                grid-column: span 2;
                grid-template-columns: 1fr 1fr;
            }
            
            .charts-container {
                grid-template-columns: 1fr;
                gap: 20px;
            }
        }

        @media (max-width: 768px) {
            .dashboard-grid {
                grid-template-columns: 1fr;
            }
            
            .stats-section {
                grid-column: span 1;
                grid-template-columns: 1fr;
            }
            
            .activity-grid {
                grid-template-columns: 1fr;
            }
            
            .health-metrics {
                grid-template-columns: 1fr;
            }
            
            .header-container {
                flex-direction: column;
                gap: 15px;
            }
        }

        /* Loading States */
        .loading {
            color: #95A5A6;
            font-style: italic;
        }

        /* Animations */
        .fade-in {
            animation: fadeIn 0.5s ease-in-out;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
    </style>
</head>
<body>
    <!-- Beta Banner -->
    {% if testing_mode %}
    <div class="beta-banner">
        🚀 BETA VERSION | Full IPFS service operational | All features unlocked for testing | Help us improve before launch!
    </div>
    {% endif %}

    <!-- Header -->
    <header class="header">
        <div class="header-container">
            <div class="logo">
                <div class="logo-icon">🍺</div>
                <div>
                    <div class="logo-text">ServeBeer</div>
                    <div style="font-size: 0.8rem; color: #95A5A6;">IPFS Guerrilla Infrastructure</div>
                </div>
            </div>
            
            <div class="user-info">
                <div class="network-status">
                    <div class="status-dot"></div>
                    <span id="network-status-text">Loading...</span>
                </div>
                <div class="user-avatar" id="user-avatar">U</div>
                <div>
                    <div style="font-weight: bold;" id="user-email">Loading...</div>
                    <div style="font-size: 0.8rem; color: #95A5A6;" id="user-tier">Loading...</div>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Dashboard -->
    <main class="main-container">
        <!-- Top Grid: Stats + Quick Actions -->
        <div class="dashboard-grid">
            <!-- Stats Section -->
            <section class="stats-section">
                <div class="stat-card fade-in">
                    <div class="stat-number" id="storage-used">Loading...</div>
                    <div class="stat-label">MB Used</div>
                    <div class="stat-trend trend-up" id="storage-trend">Loading...</div>
                </div>
                
                <div class="stat-card fade-in">
                    <div class="stat-number" id="total-pins">Loading...</div>
                    <div class="stat-label">Total Pins</div>
                    <div class="stat-trend trend-up" id="pins-trend">Loading...</div>
                </div>
                
                <div class="stat-card fade-in">
                    <div class="stat-number" id="bandwidth">Loading...</div>
                    <div class="stat-label">GB Served</div>
                    <div class="stat-trend trend-up" id="bandwidth-trend">Loading...</div>
                </div>
            </section>

            <!-- Quick Actions -->
            <section class="quick-actions">
                <h3>🚀 Quick Actions</h3>
                <button class="action-btn" onclick="showPinModal()">📌 Pin CID</button>
                <button class="action-btn" onclick="showUploadModal()">📤 Upload File</button>
                <button class="action-btn secondary" onclick="showAnalytics()">📊 View Analytics</button>
                <button class="action-btn secondary" onclick="openSponsors()">💎 Become Sponsor</button>
                <button class="action-btn secondary" onclick="openContact()">📧 Contact</button>
                <button class="action-btn danger" onclick="logout()">🚪 Logout</button>
            </section>
        </div>

        <!-- File Manager -->
        <section class="section">
            <h3>
                📁 File Manager
                <input type="text" class="file-search" placeholder="Search files..." id="file-search">
            </h3>
            
            <table class="file-table">
                <thead>
                    <tr>
                        <th>Filename</th>
                        <th>CID</th>
                        <th>Size</th>
                        <th>Type</th>
                        <th>Date</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="file-table-body">
                    <tr>
                        <td colspan="6" class="loading">Loading files...</td>
                    </tr>
                </tbody>
            </table>
        </section>

        <!-- Analytics Charts -->
        <section class="analytics-section">
            <h3>📊 Usage Analytics</h3>
            
            <div class="charts-container">
                <div class="chart-wrapper">
                    <div class="chart-title">Storage Usage (MB)</div>
                    <canvas id="storageChart" class="chart-canvas"></canvas>
                </div>
                
                <div class="chart-wrapper">
                    <div class="chart-title">Pin Activity</div>
                    <canvas id="activityChart" class="chart-canvas"></canvas>
                </div>
            </div>
            
            <div class="chart-wrapper bandwidth-chart">
                <div class="chart-title">Bandwidth Usage (MB)</div>
                <canvas id="bandwidthChart" class="chart-canvas"></canvas>
            </div>
        </section>

        <!-- Activity + Network Health -->
        <div class="activity-grid">
            <!-- Recent Activity -->
            <section class="recent-activity">
                <h3>📈 Recent Activity</h3>
                <div id="activity-container">
                    <div class="activity-item">
                        <div class="activity-icon login">🔄</div>
                        <div class="activity-details">
                            <div class="activity-text">Loading activity...</div>
                            <div class="activity-time">Please wait</div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Network Health -->
            <section class="network-health">
                <h3>🌐 Network Health</h3>
                <div class="health-metrics">
                    <div class="health-metric">
                        <div class="metric-value" id="peer-count">--</div>
                        <div class="metric-label">Connected Peers</div>
                    </div>
                    
                    <div class="health-metric">
                        <div class="metric-value" id="response-time">--</div>
                        <div class="metric-label">Response (ms)</div>
                    </div>
                    
                    <div class="health-metric">
                        <div class="metric-value" id="success-rate">--</div>
                        <div class="metric-label">Success Rate (%)</div>
                    </div>
                    
                    <div class="health-metric">
                        <div class="metric-value" id="node-version">--</div>
                        <div class="metric-label">IPFS Version</div>
                    </div>
                </div>
            </section>
        </div>
    </main>

    <!-- Chart.js for Analytics -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <script>
        // Global state
        let charts = {};
        
        // Fetch real dashboard stats
        async function updateStats() {
            try {
                const response = await fetch('/api/dashboard/stats');
                const data = await response.json();
                
                if (data.error) {
                    console.error('Stats error:', data.error);
                    return;
                }
                
                // Update stats display
                document.getElementById('storage-used').textContent = data.storage_used_mb;
                document.getElementById('total-pins').textContent = data.total_pins;
                document.getElementById('bandwidth').textContent = data.bandwidth_gb;
                
                // Update user info
                document.getElementById('user-email').textContent = data.user_email;
                document.getElementById('user-tier').textContent = `${data.user_tier} Tier${data.user_tier === 'free' ? ' (Beta)' : ''}`;
                document.getElementById('user-avatar').textContent = data.user_email.charAt(0).toUpperCase();
                document.getElementById('network-status-text').textContent = 'IPFS Online';
                
                // Update trends
                document.getElementById('storage-trend').textContent = `${data.storage_growth_percent >= 0 ? '+' : ''}${data.storage_growth_percent}% this week`;
                document.getElementById('pins-trend').textContent = `+${data.today_pins} today`;
                document.getElementById('bandwidth-trend').textContent = `${data.bandwidth_growth} today`;
                
            } catch (error) {
                console.error('Error fetching stats:', error);
                document.getElementById('network-status-text').textContent = 'Connection Error';
            }
        }
        
// Zastąp tę funkcję w dashboard_v2.html
        async function updateNetworkHealth() {
            try {
                console.log('Fetching network health...'); // Debug
                const response = await fetch('/api/dashboard/network');
                const data = await response.json();
                
                console.log('Network data received:', data); // Debug - sprawdź w konsoli przeglądarki
                
                // Upewnij się że elementy istnieją i zaktualizuj je
                const peerElement = document.getElementById('peer-count');
                const responseElement = document.getElementById('response-time');
                const successElement = document.getElementById('success-rate');
                const versionElement = document.getElementById('node-version');
                
                if (peerElement) {
                    peerElement.textContent = data.peer_count || '0';
                    console.log('Updated peer-count:', data.peer_count);
                }
                
                if (responseElement) {
                    responseElement.textContent = data.response_time_ms || '0';
                    console.log('Updated response-time:', data.response_time_ms);
                }
                
                if (successElement) {
                    successElement.textContent = data.success_rate || '0';
                    console.log('Updated success-rate:', data.success_rate);
                }
                
                if (versionElement) {
                    versionElement.textContent = data.ipfs_version || 'Unknown';
                    console.log('Updated node-version:', data.ipfs_version);
                }
                
            } catch (error) {
                console.error('Error fetching network data:', error);
                // Ustaw wartości błędu
                document.getElementById('peer-count').textContent = '0';
                document.getElementById('response-time').textContent = '0';
                document.getElementById('success-rate').textContent = '0';
                document.getElementById('node-version').textContent = 'Error';
            }
        }


// Znajdź i zastąp pierwszą inicjalizację (około linii 816-820):
        document.addEventListener('DOMContentLoaded', function() {
            console.log('DOM loaded, starting updates...');
            updateStats();
            updateNetworkHealth(); // Pierwsze wywołanie
            updateFileManager();
            
            // Usuń lub zakomentuj tę linię:
            // initializeCharts();  // Ta funkcja nie istnieje
            
            // Odświeżaj co 30 sekund
            setInterval(updateStats, 30000);
            setInterval(updateNetworkHealth, 30000);
            setInterval(updateFileManager, 60000);
        });
        
        // Fetch and display files
        async function updateFileManager(searchTerm = '') {
            try {
                const url = searchTerm ? `/api/dashboard/files?search=${encodeURIComponent(searchTerm)}` : '/api/dashboard/files';
                const response = await fetch(url);
                const data = await response.json();
                
                if (data.error) {
                    console.error('Files error:', data.error);
                    return;
                }
                
                const tbody = document.getElementById('file-table-body');
                tbody.innerHTML = '';
                
                if (data.files.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; color: #95A5A6;">No files found</td></tr>';
                    return;
                }
                
                data.files.forEach(file => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td class="file-name">${file.filename}</td>
                        <td class="file-cid" title="${file.cid}">${file.cid_short}</td>
                        <td class="file-size">${parseInt(file.size_kb, 10) || 0} KB</td>
                        <td><span class="file-type type-${file.upload_type.toLowerCase()}">${file.upload_type.toUpperCase()}</span></td>
                        <td>${file.pinned_at}</td>
                        <td class="file-actions">
                            <span class="action-icon" title="Copy CID" data-cid="${file.cid}">📋</span>
                            <span class="action-icon" title="Share" onclick="shareFile('${file.cid}')">🔗</span>
                            <span class="action-icon" title="Download" onclick="downloadFile('${file.cid}')">⬇️</span>
                        </td>
                    `;
                    tbody.appendChild(row);
                });
                
            } catch (error) {
                console.error('Error fetching files:', error);
                document.getElementById('file-table-body').innerHTML = '<tr><td colspan="6" style="text-align: center; color: #E74C3C;">Error loading files</td></tr>';
            }
        }
        
        // Fetch recent activity
        async function updateRecentActivity() {
            try {
                const response = await fetch('/api/dashboard/activity');
                const data = await response.json();
                
                if (data.error) {
                    console.error('Activity error:', data.error);
                    return;
                }
                
                const activityContainer = document.getElementById('activity-container');
                activityContainer.innerHTML = '';
                
                if (data.activities.length === 0) {
                    activityContainer.innerHTML = `
                        <div class="activity-item">
                            <div class="activity-icon login">🔄</div>
                            <div class="activity-details">
                                <div class="activity-text">No recent activity</div>
                                <div class="activity-time">Start using the service!</div>
                            </div>
                        </div>
                    `;
                    return;
                }
                
                data.activities.forEach(activity => {
                    const item = document.createElement('div');
                    item.className = 'activity-item';
                    item.innerHTML = `
                        <div class="activity-icon ${activity.icon}">
                            ${activity.icon === 'pin' ? '📌' : activity.icon === 'upload' ? '📤' : activity.icon === 'login' ? '🔐' : '⚡'}
                        </div>
                        <div class="activity-details">
                            <div class="activity-text">${activity.message}</div>
                            <div class="activity-time">${activity.time}</div>
                        </div>
                    `;
                    activityContainer.appendChild(item);
                });
                
            } catch (error) {
                console.error('Error fetching activity:', error);
            }
        }
        
        // Initialize analytics charts
        async function initializeAnalytics() {
            try {
                const response = await fetch('/api/dashboard/analytics');
                const data = await response.json();
                
                if (data.error) {
                    console.error('Analytics error:', data.error);
                    return;
                }
                
                // Create charts with proper sizing
                createStorageChart(data.storage_usage);
                createActivityChart(data.pin_activity);
                createBandwidthChart(data.bandwidth_usage);
                
            } catch (error) {
                console.error('Error initializing analytics:', error);
            }
        }
        
        // Create storage usage chart
        function createStorageChart(data) {
            const ctx = document.getElementById('storageChart');
            if (!ctx) return;
            
            if (charts.storage) {
                charts.storage.destroy();
            }
            
            charts.storage = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: data.labels.slice(-7), // Last 7 days
                    datasets: [{
                        label: 'Storage Used (MB)',
                        data: data.data.slice(-7),
                        borderColor: '#4ECDC4',
                        backgroundColor: 'rgba(78, 205, 196, 0.1)',
                        tension: 0.4,
                        fill: true,
                        pointBackgroundColor: '#4ECDC4',
                        pointBorderColor: '#ffffff',
                        pointRadius: 4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            grid: { color: 'rgba(255,255,255,0.1)' },
                            ticks: { color: '#95A5A6', font: { size: 11 } }
                        },
                        x: {
                            grid: { color: 'rgba(255,255,255,0.1)' },
                            ticks: { color: '#95A5A6', font: { size: 11 } }
                        }
                    }
                }
            });
        }
        
        // Create pin activity chart
        function createActivityChart(data) {
            const ctx = document.getElementById('activityChart');
            if (!ctx) return;
            
            if (charts.activity) {
                charts.activity.destroy();
            }
            
            charts.activity = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: data.labels.slice(-7),
                    datasets: [
                        {
                            label: 'Uploads',
                            data: data.uploads.slice(-7),
                            backgroundColor: 'rgba(46, 204, 113, 0.8)',
                            borderColor: '#2ECC71',
                            borderWidth: 1
                        },
                        {
                            label: 'Pins',
                            data: data.pins.slice(-7),
                            backgroundColor: 'rgba(52, 152, 219, 0.8)',
                            borderColor: '#3498DB',
                            borderWidth: 1
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { 
                            display: true,
                            labels: { color: '#ECF0F1', font: { size: 11 } }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            grid: { color: 'rgba(255,255,255,0.1)' },
                            ticks: { color: '#95A5A6', font: { size: 11 } }
                        },
                        x: {
                            grid: { color: 'rgba(255,255,255,0.1)' },
                            ticks: { color: '#95A5A6', font: { size: 11 } }
                        }
                    }
                }
            });
        }
        
        // Create bandwidth chart
        function createBandwidthChart(data) {
            const ctx = document.getElementById('bandwidthChart');
            if (!ctx) return;
            
            if (charts.bandwidth) {
                charts.bandwidth.destroy();
            }
            
            charts.bandwidth = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: data.labels.slice(-7),
                    datasets: [{
                        label: 'Bandwidth (MB)',
                        data: data.data.slice(-7),
                        borderColor: '#E67E22',
                        backgroundColor: 'rgba(230, 126, 34, 0.1)',
                        tension: 0.4,
                        fill: true,
                        pointBackgroundColor: '#E67E22',
                        pointBorderColor: '#ffffff',
                        pointRadius: 3
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            grid: { color: 'rgba(255,255,255,0.1)' },
                            ticks: { color: '#95A5A6', font: { size: 10 } }
                        },
                        x: {
                            grid: { color: 'rgba(255,255,255,0.1)' },
                            ticks: { color: '#95A5A6', font: { size: 10 } }
                        }
                    }
                }
            });
        }
        
        // File search functionality
        document.getElementById('file-search').addEventListener('input', function(e) {
            const searchTerm = e.target.value;
            updateFileManager(searchTerm);
        });

        // Action function - redirect to pin.html instead of showing modal
        function showPinModal() {
        // Redirect to pin.html page
                window.location.href = '/api/pin';
        }

        function showUploadModal() {
            window.location.href = '/upload';
        }

        function showAnalytics() {
            document.querySelector('.analytics-section').scrollIntoView({ behavior: 'smooth' });
        }

        function openSponsors() {
            window.open('/sponsors', '_blank');
        }
        
        function openContact() {
            window.location.href = '/contact';
        }

        function logout() {
            if (confirm('Are you sure you want to logout?')) {
                window.location.href = '/logout';
            }
        }

        // File actions
        function shareFile(cid) {
            const url = `https://ipfs.io/ipfs/${cid}`;
            if (navigator.share) {
                navigator.share({
                    title: 'IPFS File',
                    url: url
                });
            } else {
                prompt('Share this IPFS URL:', url);
            }
        }

        function downloadFile(cid) {
            window.open(`https://ipfs.io/ipfs/${cid}`, '_blank');
        }

        // Copy CID functionality
        document.addEventListener('click', function(e) {
            if (e.target.textContent === '📋' && e.target.dataset.cid) {
                const cid = e.target.dataset.cid;
                navigator.clipboard.writeText(cid).then(() => {
                    e.target.textContent = '✅';
                    setTimeout(() => {
                        e.target.textContent = '📋';
                    }, 2000);
                }).catch(() => {
                    prompt('Copy CID:', cid);
                });
            }
        });

        // Initialize dashboard
        document.addEventListener('DOMContentLoaded', function() {
            console.log('🍺 ServeBeer Dashboard v2 initializing...');
            
            // Load initial data
            updateStats();
            updateNetworkHealth();
            updateFileManager();
            updateRecentActivity();
            
            // Initialize analytics charts after a short delay
            setTimeout(() => {
                initializeAnalytics();
            }, 1000);
            
            // Set up periodic updates
            setInterval(() => {
                updateStats();
                updateNetworkHealth();
                updateRecentActivity();
            }, 30000); // Update every 30 seconds
            
            console.log('✅ ServeBeer Dashboard v2 loaded with real data!');
        });
    </script>
</body>
</html>
